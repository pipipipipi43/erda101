目前企业数字化转型期间，很多企业有业务数字化和业务服务上云的需求，以下就是目前 erda 服务了很多厂商部署到 erda cloud 的经验，
总结为以下几步 `系统全方面评估`，`服务改造和预部署`，`迁移数据准备和服务迁移` 从而让企业根据自身情况，安全快速的上云

## 系统全方面评估

### erda dice.yml
erda dice.yml 存在于代码根目录，内容基本上就是对服务的一些基础描述，比如端口服务名称运行的资源镜像，还有依赖的中间件(addon)，
当 dice.yml 被部署后会根据分支生成唯一的 runtimeID, 分支不变部署多次 runtimeID 将不变

#### erda 中间件扩展服务(addon)

erda 提供了一系列中间件的扩展服务，dice.yml 中可以声明依赖的扩展服务，然后再服务跑起来后会连带着启动一个中间件服务(也可以直接创建好再引用)，假如 runtimeID 没变多次启动服务其中间件将不会被重启而是会被复用，
所以只要不是人为的删除服务实例，则中间件将会一直执行

erda 的中间件和服务之间的联动则是根据环境变量来提供地址端口或者其他信息，服务可以通过从环境变量读取固定的 key 来对中间件进行连接和操作，对于 erda 不存在的中间件，也可以之间创建扩展服务，自定义 key 和 value 来挂载环境变量

### erda pipeline.yml

erda pipeline.yml 存在于代码根目录，你可以看成把他看成类似于 Jenkins 流水线, 内容基本都有如下几个步骤

1. 拉取代码
2. 编译代码和构建镜像
3. 将构建的镜像名称和根目录的 dice.yml 合并，然后将新的 dice.yml 生成一个制品 ID
4. 根据制品去部署服务

tip:: 制品的本质就是 dice.yml 的版本

### erda 其他概念

erda 有项目和应用的概念，应用则是代码仓库不同分支的集合，项目中包含多个应用，则项目可以简单的理解为多个代码仓库的集合

在 erda 中项目和项目基本没有关联，项目中的应用和应用之间也基本没有关联

### 服务关系和所需资源评估

对于所有服务评估其在平常峰值所需的 CPU 和 内存 并列成表格    
多应用且某些应用多模块，根据应用之间的依赖关系和模块之间的依赖关系，将各个服务的启动顺序整理成表格，以备在 erda 中作为部署的顺序

### 中间件评估

对于目前已有中间件有自己的公网地址的或者可被云主机访问的，可以先在 erda 上将服务跑起来连接同一中间件，然后在适当的时间切换流量即可, 
而上云后无法再访问的中间件，则需要将中间件进行上云操作，中间件迁移则是老生长谈的问题，一种停机然后全量同步，第二种不停机先全量同步，然后停机进行增量同步，
两种操作模式根据运维的经验和不同系统的风险进行选择


## 服务改造和预部署

### erda 使用和评估

对于如何迁移，需先了解和使用 erda，根据上面整理的信息在 erda 上进行项目创建，应用创建，代码上传，服务构建，服务部署，服务测试，先保证每个服务都能在 erda 的非生产环境都能正常跑起来，
对于那些无法跑起来或者遇到困难的点则需要询问 erda 的答疑渐进式的吧所有问题点都解决

以下是 erda 的一些功能点的问题，需要吧这些都弄通，才能掌控 erda

- erda 的监控能帮你做什么，如何使用 erda 的监控，如何接入 erda 监控，监控为啥有时候没数据
- 对于 erda 的微服务平台能帮你做什么，如何接入微服务平台
- 如何接入 erda 的注册中心(Nacos)和配置中心
- java 和 js 项目无代码侵入接入监控， 非 java 和 js 的服务如何接入 erda 的监控
- DevOps 平台代码构建过程，构建完成后服务部署流程，部署后健康检查没通过
- erda 的扩展服务怎么使用，这些中间件是否可以生产使用，生产使用的中间件应该怎么弄
- erda 的自动化测试，代码扫描，分支管理，项目协同如何使用

### 代码修改

如果项目想要对接 erda 上的一些功能则需要对代码做一定的修改

springcloud 项目，原本自带一套微服务的组件则无需接入微服务平台进行代码改造, 假如注册中心是 nacos 则可以考虑改造代码，接入 erda 的扩展服务注册中心(nacos), 而配置中心，也可以考虑使用 erda 的扩展服务配置中心

erda 上通过扩展服务的机制，会将中间件的地址和其他信息通过环境变量的形式让服务去引用，对于一些原本是基于配置中心来设置中间件地址的代码还是需要一些变更，这样做的目的是，可以让各个部署实例，根据自身需求申请中间件，
而中间件地址变更的时候无需修改任何配置，从而用户无需在配置中心配置多种环境的中间件地址

dubbo 和 springboot 项目同 springcloud 项目，自行决定是否对应 erda 的注册中和配置中心

其他语言和框架的项目，目前注册中心本质就是 nacos 中间件，其他语言或者框架理论上只要支持 nacos 都可以接入，而配置中心目前只支持 java 

### 预部署

根据代码来分，在项目中建立多个应用对应多个仓库代码，以代码仓库名称来定义应用名称

给每个应用创建 dice.yml 和 pipeline.yml，多模块应用，如果希望单独去运维，则每个模块都建立自己的 dice.yml 和 pipeline.yml, 分开去部署
，如果多个模块之间可以一起运维，则他们可以共用 dice.yml 和 pipeline.yml

tip:: 单独运维，意思是重新部署不会影响另一个服务，而共同运维则是会将两个服务都重新部署

pipeline.yml 是代码打包镜像构建的描述，一般最后一步就是使用 dice.yml 去部署，部署成功后，可以在部署中心对应看到，同一分支任意时刻只会部署出一份部署实例，多个分支则是多个不同的部署实例

部署中心查看对应的分支的实例，点击实例则可以看到服务列表，点击服务则可以看到服务实例数据和一些其他信息，用户可以查看各个服务实例的日志或者进入控制台

服务部署起来后，用户可以设置好域名，然后对该服务使用 erda 的自动化接口测试进行测试各个 api 是否能够使用，或者说有 ui 界面则可以直接通过 ui 进行手动点击应用功能进行测试是否可用

dice.yml 是服务的描述，可以描述多个服务，然后每个服务可以分别描述服务的端口，健康检查，资源大小，实例数量，依赖的扩展服务，不同环境的环境变量等等

dice,yml 整体可以看做整个服务的运行描述，pipeline.yml 可以看做是服务打包过程的描述

## 迁移数据准备和服务迁移

经过第二步，大部分服务都可以在 erda 上跑起来了，则现在可以考虑如何迁移生产环境了

### 中间件数据迁移

#### 不停机，切流量模式

可以使用扩展服务中的自定义扩展服务进行手动声明中间件的地址和其他信息，然后在生产分支的 dice.yml 中引用这个扩展服务，然后将服务跑起来，跑起来后配置好相同的域名，
然后在 nginx 或者 dns 层面切换流量到新的 erda 入网 ip 上

#### 停机, 迁移中间件数据(不推荐)

确认停机时间，给用户返回停机界面


##### 长时间停机全量同步

生产使用自定义扩展或者 aliyun 的一些扩展服务来作为中间件，然后 erda 服务跑起来，域名配置好，原来的服务网络切除，切除后等待所有服务处理完成，将中间件数据进行全量备份，
然后将备份的数据迁移到新服务的中间件中，迁移完成，验证数据是否完整


##### 短时间停机，增量同步

原先服务不停机，先使用全量备份，将全量备份数据导入到新中间件中，然后切除流量，将增量数据同步到新的中间件中，验证数据完成性，然后切换流量到 erda 服务上
